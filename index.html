<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Playables</title>

  <style>
    body{
      font-family: Arial, sans-serif;
      background:#0f1115;
      color:#e8e8e8;
      margin:0;
      padding:28px;
    }
    h1{margin:0 0 12px 0; font-size:22px;}

    .card{
      background:#151a22;
      border:1px solid #232a36;
      border-radius:10px;
      padding:14px;
      margin:12px 0;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      background:#1c2230;
      color:#fff;
      border:1px solid #2a3345;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background:#242c3c;}

    input{
      background:#0f1115;
      color:#fff;
      border:1px solid #2a3345;
      padding:8px 12px;
      border-radius:8px;
      min-width:240px;
    }

    details{margin-left:10px;}
    summary{
      cursor:pointer;
      padding:6px 8px;
      border-radius:8px;
      font-weight:700;
      user-select:none;
    }
    summary:hover{background:#1c2230;}

    .file{
      margin:6px 0 6px 18px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .run{
      background:#2ecc71;
      border:none;
      padding:10px 16px;
      border-radius:8px;
      cursor:pointer;
      font-weight:800;
      color:#08110a;
    }
    .run:hover{background:#28b463;}

    .download{
      background:#3498db;
      border:none;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      font-weight:800;
      color:#07131d;
    }
    .download:hover{background:#2f86c1;}

    .muted{opacity:.75;}
    .error{color:#ffb4b4;}
    code{background:#0f1115; padding:2px 6px; border-radius:6px; border:1px solid #2a3345;}
  </style>
</head>

<body>
  <h1>ðŸŽ® Playables</h1>

  <div class="card">
    <div class="controls">
      <button id="expandAll" class="btn">Expand all</button>
      <button id="collapseAll" class="btn">Collapse all</button>
      <input id="search" placeholder="Search folders / filesâ€¦" />
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div id="tree" class="card">Loading repository filesâ€¦</div>

<script>
(() => {
  // Exclude these basenames anywhere in the repo:
  const EXCLUDE_BASENAMES = new Set(["README.md", "index.html", "playables.json"]);

  // List only these file extensions as runnable playables:
  const ALLOWED_EXT = [".html"]; // add ".htm" if you want

  // Auto-generated at build time:
  const MANIFEST_URL = "./playables.json";

  const treeEl = document.getElementById("tree");
  const statusEl = document.getElementById("status");
  const searchEl = document.getElementById("search");

  function isAllowedPlayable(path) {
    const lower = path.toLowerCase();
    return ALLOWED_EXT.some(ext => lower.endsWith(ext));
  }

  function buildNestedTree(paths) {
    const root = { type: "dir", children: new Map() };
    for (const p of paths) {
      const segs = p.split("/").filter(Boolean);
      let cur = root;
      for (let i = 0; i < segs.length; i++) {
        const name = segs[i];
        const last = i === segs.length - 1;
        if (last) {
          cur.children.set(name, { type: "file", path: p });
        } else {
          if (!cur.children.has(name)) cur.children.set(name, { type: "dir", children: new Map() });
          cur = cur.children.get(name);
        }
      }
    }
    return root;
  }

  function sortChildren(map) {
    return [...map.entries()].sort((a,b) => {
      const A = a[1], B = b[1];
      if (A.type !== B.type) return A.type === "dir" ? -1 : 1;
      return a[0].localeCompare(b[0], undefined, { sensitivity: "base" });
    });
  }

  function renderNode(node, name, depth, pagesBase) {
    if (node.type === "file") {
      const fileDiv = document.createElement("div");
      fileDiv.className = "file";
      fileDiv.dataset.path = node.path.toLowerCase();

      const url = pagesBase + node.path;
      const filename = node.path.split("/").pop() || "playable.html";

      // Download: uses an <a download> click so it saves the file.
      const downloadBtn = document.createElement("button");
      downloadBtn.className = "download";
      downloadBtn.textContent = "â¬‡ Download";
      downloadBtn.addEventListener("click", () => {
        const a = document.createElement("a");
        a.href = url;
        a.download = filename; // hint filename
        document.body.appendChild(a);
        a.click();
        a.remove();
      });

      // Run: opens in a new tab/window
      const runBtn = document.createElement("button");
      runBtn.className = "run";
      runBtn.textContent = "â–¶ Run";
      runBtn.addEventListener("click", () => {
        window.open(url, "_blank", "noopener");
      });

      fileDiv.appendChild(downloadBtn);
      fileDiv.appendChild(runBtn);

      return fileDiv;
    }

    const details = document.createElement("details");
    details.dataset.folder = (name || "/").toLowerCase();
    if (depth === 0) details.open = true;

    const summary = document.createElement("summary");
    summary.textContent = name || "All Playables";
    details.appendChild(summary);

    const wrap = document.createElement("div");
    wrap.style.marginLeft = "10px";

    for (const [childName, childNode] of sortChildren(node.children)) {
      wrap.appendChild(renderNode(childNode, childName, depth + 1, pagesBase));
    }

    details.appendChild(wrap);
    return details;
  }

  function setAllDetails(open) {
    document.querySelectorAll("#tree details").forEach(d => d.open = open);
  }

  function applySearch(q) {
    q = q.trim().toLowerCase();

    const allFiles = [...document.querySelectorAll("#tree .file")];
    const allFolders = [...document.querySelectorAll("#tree details")];

    if (!q) {
      allFiles.forEach(el => el.style.display = "");
      allFolders.forEach(el => el.style.display = "");
      return;
    }

    allFiles.forEach(el => el.style.display = "none");
    allFolders.forEach(el => el.style.display = "none");

    // show matching files and their parent folders
    for (const fileEl of allFiles) {
      const path = fileEl.dataset.path || "";
      if (path.includes(q)) {
        fileEl.style.display = "";
        let parent = fileEl.parentElement;
        while (parent) {
          if (parent.tagName && parent.tagName.toLowerCase() === "details") {
            parent.style.display = "";
            parent.open = true;
          }
          parent = parent.parentElement;
        }
      }
    }

    // show folders that match, plus descendants
    for (const folderEl of allFolders) {
      const key = folderEl.dataset.folder || "";
      if (key.includes(q)) {
        folderEl.style.display = "";
        folderEl.open = true;
        folderEl.querySelectorAll(".file").forEach(el => el.style.display = "");
        folderEl.querySelectorAll("details").forEach(el => { el.style.display = ""; el.open = true; });
      }
    }
  }

  async function loadManifest() {
    const res = await fetch(MANIFEST_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`Could not load ${MANIFEST_URL} (HTTP ${res.status})`);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error(`${MANIFEST_URL} must be a JSON array of file paths`);
    return data;
  }

  async function main() {
    // Works on Cloudflare Pages, custom domains, etc.
    const pagesBase = `${location.origin}/`;

    try {
      statusEl.textContent = "Loadingâ€¦";

      const listed = await loadManifest();

      // normalize and filter
      const playablePaths = listed
        .filter(p => typeof p === "string")
        .map(p => p.replace(/^\/+/, "")) // trim leading slashes
        .filter(p => !EXCLUDE_BASENAMES.has((p.split("/").pop() || "").trim()))
        .filter(p => isAllowedPlayable(p));

      if (playablePaths.length === 0) {
        statusEl.textContent = "";
        treeEl.innerHTML = `<div class="muted">No playables found. Ensure <code>playables.json</code> lists your playable <code>.html</code> files.</div>`;
        return;
      }

      const nested = buildNestedTree(playablePaths);
      treeEl.innerHTML = "";
      treeEl.appendChild(renderNode(nested, "", 0, pagesBase));

      statusEl.textContent = `${playablePaths.length} playable(s)`;

      document.getElementById("expandAll").addEventListener("click", () => setAllDetails(true));
      document.getElementById("collapseAll").addEventListener("click", () => setAllDetails(false));
      searchEl.addEventListener("input", (e) => applySearch(e.target.value));

    } catch (err) {
      statusEl.textContent = "";
      treeEl.innerHTML = `
        <div class="error">Failed to load file list.</div>
        <div class="muted" style="margin-top:8px;">
          ${String(err.message || err)}
          <br><br>
          Fix:
          <ul>
            <li>Make sure <code>playables.json</code> exists in the repo root.</li>
            <li>It must be a JSON array of paths to your playable <code>.html</code> files.</li>
            <li>If you generate it in build, confirm your Cloudflare build command runs that generator.</li>
          </ul>
        </div>
      `;
    }
  }

  main();
})();
</script>

</body>
</html>
